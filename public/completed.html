<!doctype html>

<html lang=en>
    <head>
        <meta charset=UTF-8>
        <meta name=viewport content="width=device-width, initial-scale=1, minimum-scale=1">
        <meta name=description content="LogIt Completed Tasks">
        <title>Completed Tasks</title>
        <link rel="stylesheet" type="text/css" href="css/base.css">

    </head>
    <body>

        <div id="modal">
            <div class="modal-content">
                <div class="modal-header">Edit Task<span class="close">&times;</span></div>      
                <ul class=modal-list>
                </ul>
            </div>
        </div>

        <div class=topnav>
            <div id=hamburger>
                <span></span>
                <span></span>
                <span></span>
            </div>
            <button id=createbtn>Create Task</button>
        </div>

        <div id=sidebar>
            <ul>
                <li id=todo>Todo</li>
                <li id=completed style="color:#D8124E">Completed</li>
                <li id=signout>Logout</li>
            </ul>
        </div>

        <h1>Tasks Completed</h1>

        <ul id=list>
        </ul>
        
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-firestore.js"></script>
        <script src="js/app.js"></script>
        <script src="js/main.js"></script>

        <script>
            var database = firebase.firestore();
            firebase.firestore().settings({
                timestampsInSnapshots: true
            });
   
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    database.collection("users").doc(user.uid).collection("completed").orderBy("timestamp").get()
                    .then(snapshot => {
                        snapshot.forEach(doc => {
                            var date = doc.data().date; 
                            var task = `<li id=${doc.id}>` + "<span style='float:left; font-weight: bold'>" + doc.data().title + "</span><span style='float:right'>"  
                                + `<button id='edit_${doc.id}' class='task edit' onclick='editTask(this.id, "completed")'>Edit</button>`  
                                + `<button id='dele_${doc.id}' class='task delete' onclick='deleteTask(this.id, "completed")'>Delete</button>` 
                                + "</span>" + `<br><span style='font-size: 18px'>${date}` + "</span></li>";
                            document.getElementById("list").innerHTML += task;
                        }); 
                    })
                    .catch(err => {
                        console.log("Error getting documents ", err);
                    });
                }
                else {
                    window.location.href = "index.html";
                }
            });
/*
            window.onload = function() {
                document.getElementById("signout").addEventListener("click", logout);
                document.getElementById("createbtn").addEventListener("click", createTask);
                document.getElementById("hamburger").addEventListener("click", toggleSidebar);
                document.getElementById("todo").addEventListener("click", viewTodo);
                document.getElementsByClassName("close")[0].addEventListener("click", close);
                window.addEventListener("click", closeOutside);
            }

            function logout() {
                firebase.auth().signOut().then(function() {
                    window.location.href = "index.html";
                }).catch(function(error) {
                    alert(error);
                });
            }

            function createTask() {
                window.location.href = "createTask.html";
            }

            function toggleSidebar() {
                document.getElementById("sidebar").classList.toggle("active");
            }

            function viewTodo() {
                window.location.href = "home.html";
            }

            function close() {
                document.getElementById("modal").style.display = "none";
            }

            function closeOutside(e) {
                if (e.target === modal) {
                    document.getElementById("modal").style.display = "none";
                }
            }

            function revise(taskID, type) {
                var title = document.getElementById("title").value;
                var date = document.getElementById("date").value;
                var time = document.getElementById("time").value;
                var description = document.getElementById("description").value;
                
                if (title === "") {
                    alert("Please enter a title.");
                    return;
                }
                if (date === "") {
                    alert("Please enter a date.");
                    return;
                }
                if (time === "") {
                    alert("Please enter a time.");
                    return;
                }

                var timestamp = Date.parse(date + " " + time)/1000;
                if (timestamp === undefined || timestamp === "") timestamp = 0;
                var user = firebase.auth().currentUser;

                database.collection("users").doc(user.uid).collection(type).doc(taskID).set({
                    title: title,
                    date: date,
                    time: time,
                    description: description,
                    timestamp: timestamp
                }).then(function() {
                    document.getElementsByClassName("modal-list")[0].innerHTML = "";
                    location.reload();
                }).catch(function(error) {
                    console.log("Error: " + error);
                });
            }

            function editTask(clickedID, type) {
                var taskID = clickedID.slice(5);
                var userID = firebase.auth().currentUser.uid;
                var date, time, description, timestamp, title;
                document.getElementById("modal").style.display = "block";
                database.collection("users").doc(userID).collection(type).doc(taskID).get().then(function(doc) {
                    if (doc.exists) {
                        date = doc.data().date;
                        description = doc.data().description;
                        time = doc.data().time;
                        title = doc.data().title; 
                        titleArr = title.split(" "); // Ensures the displayed title includes words after spaces

                        var info = `<label for=title>Title</label>
                                    <input type=text id=title name=title placeholder='Enter a title' value=${titleArr.join("&nbsp;")}><br>
                                    <label for=date>Date</label>
                                    <input type=date id=date name=date placeholder='Enter a date' value=${date}><br>
                                    <label for=time>Time</label>
                                    <input type=time id=time name=time placeholder='Enter a time' value=${time}><br>
                                    <label for=description>Description</label>
                                    <textarea id=description name=description placeholder='Enter a description' value=${description}></textarea><br>
                                    <button id=revise onclick="revise( '${taskID}', 'completed' )">Revise</button>`;

                        document.getElementsByClassName("modal-list")[0].innerHTML = info;
                    }
                })
            }

            function deleteTask(clickedID, type) {
                var taskID = clickedID.slice(5);
                var userID = firebase.auth().currentUser.uid;
                database.collection("users").doc(userID).collection(type).doc(taskID).delete()
                .then(function() {
                    console.log("Successfully deleted document");
                    document.getElementById(taskID).style.display = "none";
                }).catch(function(error) {
                    console.log("Error removing document: ", error);
                });
            }*/

        </script>
        <noscript>JavaScript not enabled</noscript>
    </body>
</html>